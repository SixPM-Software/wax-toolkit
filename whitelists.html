<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Whitelists</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython.min.js">
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython_stdlib.min.js">
        </script>

        <link rel="icon" href="img/favicon-32x32.png">

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <style>
            .b-example-divider {
                height: 3rem;
                background-color: rgba(0, 0, 0, .1);
                border: solid rgba(0, 0, 0, .15);
                border-width: 1px 0;
                box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
            }
            

        </style>
    </head>
    <body onload="brython()">

        <div class="bg-dark text-secondary px-4 py-5 text-center">
            <div class="py-5">
                <img class="d-block mx-auto mb-4" src="img/gold stamp.png" alt="" width="72" height="72">
                <h1 class="display-5 fw-bold text-white">Whitelists (Beta)</h1>
                <div class="col-lg-6 mx-auto">
                    <p class="fs-5 mb-4">Whitelist generation tool.</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <a href="#data-form"><button type="button" class="btn btn-outline-info btn-lg px-4 me-sm-3 fw-bold">Generate a whitelist!</button></a>
                        <a href="#see-how-it-works"><button type="button" class="btn btn-outline-secondary btn-lg px-4">See how it works</button></a>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-2 py-5 my-4">
            <h1>Whitelist Generator</h2>
            <button class="btn btn-primary" id="add-field">Add Requirement</button>
            <!-- <button class="btn btn-dark" id="add-blacklist">Add Blacklist</button> -->
            <button class="btn btn-success" id="generate-whitelist-btn">Generate Whitelist</button>
            <div class="container py-5">
                <form id="whitelist-form">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">I want to whitelist accounts that fulfill</span>
                        </div>
                        <select id="bool-check" class="form-control">
                            <option selected>any</option>
                            <option>all</option>
                        </select>
                        <div class="input-group-append">
                            <span class="input-group-text">of the following criteria:</span>
                        </div>
                    </div>
                </form>
            </div>  
            <div class="container py-5">
                <p class="lead" id="sneaky-text"></p>
                <div class="input-group">
                    <textarea class="form-control" id="output" placeholder="Your whitelist will appear here!" rows=5></textarea>
                    <button class="btn btn-outline-secondary" id="copy-btn" type="button">Copy!</button>
                </div>
            </div>
        </div>

        <footer class="footer mt-auto py-3 bg-light">
            <div class="container">
              <span class="text-muted">Built in Python with ❤️ by stuckatsixpm</span>
            </div>
        </footer>

        
        <script type="text/python" id="whitelistgen">
            import base64
            import calendar
            import csv
            import datetime
            import json
            import time
            from operator import itemgetter

            from browser import document, ajax, html, aio
            import browser.timer
            global field_count
            field_count = 0

            def add_field(e):
                global field_count
                package = html.DIV(Class="input-group",id="criteria"+str(field_count))
                sub_div = html.DIV(Class="input-group-prepend")
                sub_div <= html.SPAN("hold at least",Class="input-group-text")
                package <= sub_div 
                package <= html.INPUT(**{"Class":"form-control","type":"text","aria-label":"type","value":"1","style":{"direction": "rtl"},"id":"amount"+str(field_count)})
                sub_div = html.DIV(Class="input-group-prepend")
                sub_div <= html.SPAN("NFT(s) from the",Class="input-group-text")
                package <= sub_div
                sub_div = html.SELECT(Class="form-control",id="type"+str(field_count))
                sub_div <= html.OPTION("Collection")
                sub_div <= html.OPTION("Template")
                package <= sub_div
                package <= html.INPUT(**{"Class":"form-control","type":"text","aria-label":"type","placeholder":"Name/ID","id":"id"+str(field_count)})
                package <= html.BUTTON("Delete",**{"Class":"btn btn-outline-danger","type":"button","id":"criteriabtn"+str(field_count)})

                document["whitelist-form"] <= package
                document["criteriabtn"+str(field_count)].bind("click",delete_element)
                field_count += 1

            def delete_element(e):
                del document[e.target.parent.id]
            
            async def gen_whitelist(e):
                checks = []
                for i in range(field_count):
                    try:
                        document["criteria"+str(i)]
                        checks.append(str(i))
                    except:pass
                operator = document['bool-check'].value
                responses = []
                for i in checks:
                    data = (document["type"+i].value,document["id"+i].value,document["amount"+i].value)
                    responses.append(data)

                endpoint = "https://wax.api.atomicassets.io/atomicassets/v1/accounts?limit=5000&order=desc"
                whitelist = []
                for search in responses:
                    page = 0
                    wallets = []
                    if search[0] == "Collection":
                        type_string = "collection_name"
                    #elif search[0] == "Schema":
                    #    type_string = "schema_name"
                    elif search[0] == "Template":
                        type_string = "template_id"
                    print("using",type_string)
                    while True:
                        #try:
                        if True:
                            req = ajax.ajax()
                            url = f'{endpoint}&{type_string}={search[1]}&page={page}'
                            req.open('GET', url, False)
                            req.send()
                            data = json.loads(req.responseText)
                            new = data['data']
                            wallets.extend([a["account"] for a in new if int(a["assets"]) >= int(search[2])])
                        #except:
                        #    print("ERROR")
                        #    continue
                        if len(new) < 5000:
                            break
                        else:
                            page += 1
                        print(len(wallets),"wallets found")
                    whitelist.append(set(wallets))
                if operator == "any":
                    whitelist = set.union(*whitelist)
                if operator == "all":
                    whitelist = set.intersection(*whitelist)
                document["sneaky-text"].text = str(len(whitelist)) + " accounts match the criteria!"
                document["output"].value = "\n".join(whitelist)
                    

            document['add-field'].bind('click',add_field)
            document['generate-whitelist-btn'].bind('click',lambda e:aio.run(gen_whitelist(e)))

        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    </body>
</html> 
